<div class="h-screen bg-gray-50 p-4 flex flex-col overflow-hidden">
  <!-- Header -->
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-2xl font-bold text-gray-900">Calendrier des Locations</h1>
    <div class="flex items-center space-x-2">
      <button (click)="goToPreviousMonth()" class="p-2 bg-white border rounded hover:bg-gray-50">
        <i class="fas fa-chevron-left"></i>
      </button>
      <div class="text-lg font-semibold px-4">{{ currentMonth?.monthName || '' }} {{ currentMonth?.year || '' }}</div>
      <button (click)="goToNextMonth()" class="p-2 bg-white border rounded hover:bg-gray-50">
        <i class="fas fa-chevron-right"></i>
      </button>
      <button (click)="goToToday()" class="px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Aujourd'hui</button>
    </div>
  </div>

  <!-- Loading/Error -->
  <div *ngIf="loading" class="flex justify-center py-20">
    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
  </div>
  <div *ngIf="error" class="bg-red-50 border border-red-200 rounded p-4 mb-6 flex items-center">
    <i class="fas fa-exclamation-circle text-red-600 mr-2"></i>
    <span class="text-red-700">{{ error }}</span>
    <button (click)="loadData()" class="ml-auto px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700">Réessayer</button>
  </div>

  <!-- Calendar -->
  <div *ngIf="!loading" class="bg-white rounded border shadow-sm mb-6 flex-1 flex flex-col overflow-hidden">
    <!-- Days Header -->
    <div class="grid grid-cols-7 bg-gray-50 border-b">
      <div *ngFor="let day of weekDays" class="p-2 text-center text-sm font-medium text-gray-700 border-r last:border-r-0">{{ day }}</div>
    </div>
    
    <!-- Calendar Grid -->
    <div class="grid grid-cols-7 flex-1 overflow-auto">
      <div *ngFor="let day of currentMonth.days; trackBy: trackByDate"
           class="min-h-[80px] border-r border-b last:border-r-0 p-1 relative"
           [ngClass]="{
             'bg-gray-100 opacity-40': !day.isCurrentMonth,
             'bg-white group cursor-pointer hover:bg-gray-50': day.isCurrentMonth,
             'bg-blue-200': day.isToday && day.isCurrentMonth
           }"
           (click)="day.isCurrentMonth ? selectDay(day) : null">
        
        <!-- Day number and indicators -->
        <div class="flex justify-between items-start">
          <span class="text-sm select-none" 
                [ngClass]="{
                  'text-gray-300': !day.isCurrentMonth,
                  'text-gray-900': day.isCurrentMonth && !day.isToday,
                  'text-blue-600 font-bold': day.isToday && day.isCurrentMonth
                }">
            {{ day.day }}
          </span>
          
          <!-- Revenue and reservation indicators - only for current month -->
          <div *ngIf="day.isCurrentMonth" class="flex flex-col items-end space-y-1">
            <span *ngIf="day.revenue > 0" 
                  class="text-xs px-1 py-0.5 rounded bg-green-100 text-green-700">
              {{ formatCurrency(day.revenue) }}
            </span>
            <!-- Calendar icon for days with reservations -->
            <div *ngIf="day.hasReservations" class="flex items-center space-x-1">
              <i class="fas fa-calendar-check text-blue-600 text-xs"></i>
              <span class="text-xs text-blue-600 font-medium">{{ day.reservations.length }}</span>
            </div>
          </div>
        </div>
        
        <!-- Reservations list - only for current month -->
        <div *ngIf="day.isCurrentMonth" class="mt-1 space-y-0.5">
          <div *ngFor="let reservation of getVisibleReservations(day); let i = index"
               class="text-xs p-0.5 rounded truncate border cursor-pointer flex items-center space-x-1"
               [ngClass]="getReservationStatusClass(reservation.status)"
               (click)="viewReservation(reservation, $event)">
            <i class="fas fa-calendar-day text-xs"></i>
            <span>{{ getClientName(reservation.clientId) }}</span>
          </div>
          <div *ngIf="hasHiddenReservations(day)" 
               class="text-xs text-gray-500 text-center cursor-pointer flex items-center justify-center space-x-1" 
               (click)="selectDay(day)">
            <i class="fas fa-calendar-plus text-xs"></i>
            <span>+{{ getHiddenReservationsCount(day) }}</span>
          </div>
        </div>
        
        <!-- Add reservation button - only for current month days without reservations -->
        <button *ngIf="day.isCurrentMonth && !day.hasReservations" 
                (click)="addReservation(day.date, $event)"
                class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 bg-white bg-opacity-90 text-xs text-blue-600 transition-opacity">
          <i class="fas fa-plus"></i>
        </button>
        
        <!-- Disabled overlay for non-current month days -->
        <div *ngIf="!day.isCurrentMonth" 
             class="absolute inset-0 cursor-not-allowed"></div>
      </div>
    </div>
  </div>
 
</div>

<!-- Day Modal - Keep this for showing all reservations in a day -->
<div *ngIf="showDayModal && selectedDay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" (click)="closeDayModal()">
  <div class="bg-white rounded p-6 max-w-md w-full max-h-[90vh] flex flex-col" (click)="$event.stopPropagation()">
    <div class="flex justify-between items-center mb-4 flex-shrink-0">
      <h3 class="font-semibold">{{ selectedDay.day }} {{ currentMonth?.monthName || '' }}</h3>
      <button (click)="closeDayModal()" class="text-gray-400"><i class="fas fa-times"></i></button>
    </div>
    
    <div class="grid grid-cols-2 gap-4 mb-4 text-center flex-shrink-0">
      <div class="bg-blue-50 p-3 rounded">
        <div class="text-xl font-bold text-blue-600">{{ selectedDay.reservations.length }}</div>
        <div class="text-sm">Réservations</div>
      </div>
      <div class="bg-green-50 p-3 rounded">
        <div class="text-xl font-bold text-green-600">{{ formatCurrency(selectedDay.revenue) }}</div>
        <div class="text-sm">Revenus</div>
      </div>
    </div>
    
    <div class="space-y-2 overflow-y-auto mb-4 flex-1 min-h-0">
      <div *ngFor="let reservation of selectedDay.reservations"
           class="border rounded p-2 hover:bg-gray-50 cursor-pointer text-sm flex justify-between items-center"
           (click)="viewReservation(reservation)">
        <div class="flex items-center space-x-2">
          <i class="fas fa-calendar-alt text-blue-600"></i>
          <span>{{ getClientName(reservation.clientId) }}</span>
        </div>
        <span>{{ formatCurrency(reservation.totalPrice) }}</span>
      </div>
    </div>
    
    <div class="flex space-x-2 flex-shrink-0">
      <button (click)="addReservation(selectedDay.date)" class="flex-1 px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Nouvelle</button>
      <button (click)="closeDayModal()" class="flex-1 px-3 py-2 bg-gray-200 rounded hover:bg-gray-300">Fermer</button>
    </div>
  </div>
</div>

<!-- Reservation Detail Dialog -->
<app-reservation-detail-dialog
  *ngIf="selectedReservationId"
  [reservationId]="selectedReservationId"
  [isVisible]="showDetailDialog"
  (closeDialog)="closeReservationDetail()"
></app-reservation-detail-dialog>